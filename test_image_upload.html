<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾åºŠä¸Šä¼ æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .upload-area { 
            border: 2px dashed #ccc; 
            padding: 20px; 
            text-align: center; 
            margin: 20px 0;
            cursor: pointer;
        }
        .upload-area:hover { background-color: #f5f5f5; }
        .result { 
            margin: 20px 0; 
            padding: 15px; 
            background-color: #f0f0f0; 
            border-radius: 5px;
        }
        .image-preview { max-width: 300px; margin: 10px 0; }
        .log { 
            background-color: #000; 
            color: #0f0; 
            padding: 10px; 
            font-family: monospace; 
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .step.active { background-color: #e3f2fd; }
        .step.completed { background-color: #e8f5e8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å›¾åºŠä¸Šä¼ åŠŸèƒ½æµ‹è¯•</h1>
        <p>æµ‹è¯•æ­¥éª¤Aâ†’Bâ†’Cçš„å®Œæ•´æµç¨‹ï¼ŒéªŒè¯å›¾åºŠä¸Šä¼ å’Œimg2imgåŠŸèƒ½</p>
        
        <div class="step" id="step1">
            <h3>æ­¥éª¤1ï¼šä¸Šä¼ å›¾ç‰‡</h3>
            <div class="upload-area" id="uploadArea">
                <p>ğŸ“· ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</p>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>
            <div id="imagePreview"></div>
            <button id="uploadBtn" disabled>ä¸Šä¼ åˆ°å›¾åºŠ</button>
        </div>

        <div class="step" id="step2">
            <h3>æ­¥éª¤2ï¼šæ¨¡æ‹Ÿæ­¥éª¤Aï¼ˆç‰©å“è¯†åˆ«ï¼‰</h3>
            <button id="stepABtn" disabled>è¿è¡Œæ­¥éª¤A</button>
            <div id="stepAResult" class="result" style="display: none;"></div>
        </div>

        <div class="step" id="step3">
            <h3>æ­¥éª¤3ï¼šæ¨¡æ‹Ÿæ­¥éª¤Bï¼ˆé£æ°´åˆ†æï¼‰</h3>
            <button id="stepBBtn" disabled>è¿è¡Œæ­¥éª¤B</button>
            <div id="stepBResult" class="result" style="display: none;"></div>
        </div>

        <div class="step" id="step4">
            <h3>æ­¥éª¤4ï¼šæ¨¡æ‹Ÿæ­¥éª¤Cï¼ˆå›¾åƒç”Ÿæˆï¼‰</h3>
            <button id="stepCBtn" disabled>è¿è¡Œæ­¥éª¤Cï¼ˆä½¿ç”¨å›¾åºŠURLï¼‰</button>
            <div id="stepCResult" class="result" style="display: none;"></div>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script>
        let uploadedImageUrl = '';
        let stepAData = null;
        let stepBData = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'image-preview';
                    document.getElementById('imagePreview').innerHTML = '';
                    document.getElementById('imagePreview').appendChild(img);
                    document.getElementById('uploadBtn').disabled = false;
                    log(`âœ… å›¾ç‰‡å·²é€‰æ‹©: ${file.name}, å¤§å°: ${(file.size/1024).toFixed(1)}KB`);
                };
                reader.readAsDataURL(file);
            }
        });

        // ä¸Šä¼ åˆ°å›¾åºŠ
        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            log('ğŸ”„ å¼€å§‹ä¸Šä¼ åˆ°å›¾åºŠ...');
            document.getElementById('uploadBtn').disabled = true;

            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch('http://localhost:3001/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    uploadedImageUrl = result.url || result.localUrl;
                    log(`âœ… å›¾åºŠä¸Šä¼ æˆåŠŸï¼`);
                    log(`ğŸ“ å…¬ç½‘URL: ${result.url}`);
                    log(`ğŸ“ æœ¬åœ°URL: ${result.localUrl}`);
                    log(`ğŸ·ï¸ æ‰˜ç®¡çŠ¶æ€: ${result.hosted ? 'å·²æ‰˜ç®¡åˆ°imgbb' : 'ä½¿ç”¨æœ¬åœ°URL'}`);
                    
                    document.getElementById('step1').classList.add('completed');
                    document.getElementById('stepABtn').disabled = false;
                } else {
                    log(`âŒ ä¸Šä¼ å¤±è´¥: ${result.error}`);
                }
            } catch (error) {
                log(`âŒ ä¸Šä¼ é”™è¯¯: ${error.message}`);
            } finally {
                document.getElementById('uploadBtn').disabled = false;
            }
        });

        // æ¨¡æ‹Ÿæ­¥éª¤A - ç‰©å“è¯†åˆ«
        document.getElementById('stepABtn').addEventListener('click', async () => {
            log('ğŸ”„ è¿è¡Œæ­¥éª¤Aï¼ˆç‰©å“è¯†åˆ«ï¼‰...');
            document.getElementById('stepABtn').disabled = true;
            document.getElementById('step2').classList.add('active');

            try {
                // æ¨¡æ‹Ÿè¯†åˆ«ç»“æœ
                stepAData = {
                    objects: [
                        { name: "ç™½è‰²å°ç¯", position: "å·¦ä¸Šè§’", type: "lighting" },
                        { name: "ç™½è‰²ç¬”ç­’", position: "ä¸­é—´åå³", type: "storage" },
                        { name: "å¤šè‚‰æ¤ç‰©", position: "å³ä¾§", type: "plant" },
                        { name: "èºæ—‹ç¬”è®°æœ¬", position: "ä¸­é—´", type: "stationery" },
                        { name: "è“è‰²ç¬”è®°æœ¬", position: "å³ä¾§", type: "stationery" },
                        { name: "é»‘è‰²é’¢ç¬”", position: "ç¬”ç­’å†…", type: "writing" }
                    ],
                    layout: "æ•´æ´çš„æœ¨è´¨ä¹¦æ¡Œ",
                    direction: "ååŒ—æœå—",
                    imageUrl: uploadedImageUrl
                };

                document.getElementById('stepAResult').innerHTML = `
                    <h4>è¯†åˆ«ç»“æœï¼š</h4>
                    <p><strong>å¸ƒå±€ï¼š</strong>${stepAData.layout}</p>
                    <p><strong>æœå‘ï¼š</strong>${stepAData.direction}</p>
                    <p><strong>è¯†åˆ«ç‰©å“ï¼š</strong></p>
                    <ul>
                        ${stepAData.objects.map(obj => `<li>${obj.name} - ${obj.position}</li>`).join('')}
                    </ul>
                `;
                document.getElementById('stepAResult').style.display = 'block';
                
                log(`âœ… æ­¥éª¤Aå®Œæˆï¼Œè¯†åˆ«äº† ${stepAData.objects.length} ä¸ªç‰©å“`);
                document.getElementById('step2').classList.add('completed');
                document.getElementById('stepBBtn').disabled = false;
            } catch (error) {
                log(`âŒ æ­¥éª¤Aé”™è¯¯: ${error.message}`);
            } finally {
                document.getElementById('stepABtn').disabled = false;
            }
        });

        // æ¨¡æ‹Ÿæ­¥éª¤B - é£æ°´åˆ†æ
        document.getElementById('stepBBtn').addEventListener('click', async () => {
            log('ğŸ”„ è¿è¡Œæ­¥éª¤Bï¼ˆé£æ°´åˆ†æï¼‰...');
            document.getElementById('stepBBtn').disabled = true;
            document.getElementById('step3').classList.add('active');

            try {
                // æ¨¡æ‹Ÿé£æ°´å»ºè®®
                stepBData = {
                    advice: "æ ¹æ®å½“å‰ä¹¦æ¡Œå¸ƒå±€ï¼Œå»ºè®®æ·»åŠ ä»¥ä¸‹é£æ°´å…ƒç´ æ¥æå‡æ–‡æ˜Œä½èƒ½é‡ï¼š",
                    itemsToAdd: [
                        { item: "æ–‡æ˜Œå¡”", position: "ä¹¦æ¡Œå·¦ä¸Šè§’ï¼ˆæ–‡æ˜Œä½ï¼‰", reason: "å¢å¼ºå­¦ä¸šå’Œäº‹ä¸šè¿åŠ¿" },
                        { item: "å¯Œè´µç«¹", position: "ä¹¦æ¡Œåæ–¹çª—å°", reason: "æå‡ç”Ÿæ°”å’Œè´¢è¿" },
                        { item: "æš–å…‰å°ç¯", position: "ä¹¦æ¡Œå·¦ä¾§ï¼ˆé’é¾™ä½ï¼‰", reason: "è¡¥å……é˜³æ°”ï¼Œæ”¹å–„ç…§æ˜" },
                        { item: "åœ†å½¢èšå®ç›†", position: "ä¹¦æ¡Œä¸­å¤®åå‰", reason: "èšè´¢çº³æ°”" }
                    ],
                    layout: "ä¿æŒç°æœ‰æ•´æ´å¸ƒå±€ï¼Œæ³¨æ„ç‰©å“æ‘†æ”¾çš„äº”è¡Œå¹³è¡¡",
                    originalImageUrl: uploadedImageUrl
                };

                document.getElementById('stepBResult').innerHTML = `
                    <h4>é£æ°´åˆ†æç»“æœï¼š</h4>
                    <p>${stepBData.advice}</p>
                    <p><strong>å»ºè®®æ·»åŠ ï¼š</strong></p>
                    <ul>
                        ${stepBData.itemsToAdd.map(item => `<li><strong>${item.item}</strong> - ${item.position}<br><small>${item.reason}</small></li>`).join('')}
                    </ul>
                    <p><strong>å¸ƒå±€å»ºè®®ï¼š</strong>${stepBData.layout}</p>
                `;
                document.getElementById('stepBResult').style.display = 'block';
                
                log(`âœ… æ­¥éª¤Bå®Œæˆï¼Œç”Ÿæˆäº† ${stepBData.itemsToAdd.length} æ¡é£æ°´å»ºè®®`);
                document.getElementById('step3').classList.add('completed');
                document.getElementById('stepCBtn').disabled = false;
            } catch (error) {
                log(`âŒ æ­¥éª¤Bé”™è¯¯: ${error.message}`);
            } finally {
                document.getElementById('stepBBtn').disabled = false;
            }
        });

        // æ¨¡æ‹Ÿæ­¥éª¤C - å›¾åƒç”Ÿæˆ
        document.getElementById('stepCBtn').addEventListener('click', async () => {
            log('ğŸ”„ è¿è¡Œæ­¥éª¤Cï¼ˆå›¾åƒç”Ÿæˆï¼‰...');
            log(`ğŸ“ ä½¿ç”¨å‚è€ƒå›¾URL: ${uploadedImageUrl}`);
            document.getElementById('stepCBtn').disabled = true;
            document.getElementById('step4').classList.add('active');

            try {
                // æ¨¡æ‹Ÿè°ƒç”¨ç”Ÿæˆæ¥å£
                const response = await fetch('http://localhost:3001/api/fengshui/generate-ref', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        originalImageUrl: uploadedImageUrl,
                        fengshuiAdvice: stepBData,
                        providerCId: 'Doubao',
                        prompt: `åœ¨ä¿æŒåŸå›¾ä¸æ”¹å˜é£æ ¼ä¸å¸ƒå±€çš„åŸºç¡€ä¸Šï¼Œä»…æ·»åŠ æˆ–è°ƒæ•´ä»¥ä¸‹å…ƒç´ ï¼š${stepBData.itemsToAdd.map(item => `${item.item}(${item.position})`).join(',')}`
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    log(`âœ… æ­¥éª¤Cå®Œæˆï¼ç”Ÿæˆå›¾ç‰‡: ${result.imageUrl}`);
                    document.getElementById('stepCResult').innerHTML = `
                        <h4>ç”Ÿæˆç»“æœï¼š</h4>
                        <img src="${result.imageUrl}" class="image-preview" alt="ç”Ÿæˆç»“æœ">
                        <p><strong>å›¾åºŠçŠ¶æ€ï¼š</strong>${result.hosted ? 'ä½¿ç”¨å…¬ç½‘URL' : 'ä½¿ç”¨æœ¬åœ°URL'}</p>
                        <p><strong>å‚è€ƒå›¾ï¼š</strong>åŸºäºåŸå›¾è¿›è¡Œé£æ°´å…ƒç´ è°ƒæ•´</p>
                    `;
                    document.getElementById('stepCResult').style.display = 'block';
                    document.getElementById('step4').classList.add('completed');
                } else {
                    log(`âŒ ç”Ÿæˆå¤±è´¥: ${result.error}`);
                }
            } catch (error) {
                log(`âŒ æ­¥éª¤Cé”™è¯¯: ${error.message}`);
            } finally {
                document.getElementById('stepCBtn').disabled = false;
            }
        });
    </script>
</body>
</html>